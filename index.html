<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>EcoPledge Tracker</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2a;
      --muted: #9fb3c8;
      --text: #e6edf3;
      --accent: #51d289;
      --warning: #ffb86c;
      --danger: #ff6b6b;
      --ok: #67e8f9;
      --border: #203049;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 800px at 70% -10%, #14213b, var(--bg));
      color: var(--text);
    }
    header { padding: 24px 16px; border-bottom: 1px solid var(--border); backdrop-filter: blur(4px); position: sticky; top: 0; background: rgba(11,18,32,0.7); z-index: 5; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 4px; font-size: 26px; letter-spacing: 0.3px; }
    p.sub { margin: 0; color: var(--muted); }

    .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 20px; margin-top: 16px; align-items: start; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.1)); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04); overflow: hidden; }
    .card h2 { margin: 0; padding: 16px 16px 0; font-size: 18px; }
    .card .body { padding: 16px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px 12px; background: #0e1626; color: var(--text); border: 1px solid var(--border); border-radius: 10px; outline: none; }
    textarea { min-height: 64px; resize: vertical; }

    button { appearance: none; border: 0; background: var(--accent); color: #0b1220; font-weight: 700; padding: 10px 14px; border-radius: 10px; cursor: pointer; transition: transform .05s ease, filter .2s ease; }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    button.secondary { background: #203049; color: var(--text); font-weight: 600; }
    button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }

    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }

    .status { padding: 8px 12px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; border-radius: 999px; display: inline-block; }
    .dot.ok { background: #34d399; }
    .dot.bad { background: var(--danger); }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { position: sticky; top: 0; background: #0f172a; z-index: 2; }
    tbody tr.invalid { background: rgba(255, 107, 107, 0.06); }
    code.small { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 2px 6px; background: #0e1626; border: 1px solid var(--border); border-radius: 6px; }

    .muted { color: var(--muted); }
    .spacer { height: 10px; }
    .footer { color: var(--muted); font-size: 12px; padding: 10px 0 24px; }

    /* About modal + FAB */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index: 50; }
    .modal { width: min(720px, 92vw); background: #0c1424; border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .modal header { position: static; background: transparent; border-bottom: 1px solid var(--border); }
    .modal .body { padding: 16px; }
    .kbd { font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 6px; background:#0e1626; }
    .fab { position: fixed; right: 16px; bottom: 16px; z-index: 60; padding: 12px 16px; border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <h1>ðŸŒ± EcoPledge Tracker</h1>
        <p class="sub">Make a pledge, record it on a transparent chain, and prove tamperâ€‘resistance. Perfect for a 4â€‘minute hackathon demo.</p>
      </div>
      <div class="toolbar">
        <button class="ghost" id="aboutBtnHeader" title="What is this?" aria-label="Open About">About</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card" id="pledgeCard">
        <h2>Create a pledge</h2>
        <div class="body">
          <div class="row">
            <div>
              <label for="name">Your name</label>
              <input id="name" placeholder="e.g., Innocent" />
            </div>
            <div>
              <label for="category">Category</label>
              <select id="category">
                <option value="transport">Transport</option>
                <option value="energy">Energy</option>
                <option value="waste">Waste</option>
                <option value="water">Water</option>
                <option value="other" selected>Other</option>
              </select>
            </div>
          </div>
          <div class="spacer"></div>
          <div>
            <label for="pledge">Your pledge</label>
            <textarea id="pledge" placeholder="e.g., I'll switch to reusable bottles this month"></textarea>
          </div>
          <div class="spacer"></div>
          <div class="toolbar">
            <button id="addBtn">Add pledge to chain</button>
            <button class="secondary" id="sampleBtn" title="Insert a few demo entries fast">Add sample pledges</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Chain status</h2>
        <div class="body">
          <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap: wrap; gap: 8px;">
            <div id="statusBadge" class="status" aria-live="polite"><span class="dot ok" id="statusDot"></span><span id="statusText">Valid chain</span></div>
            <div class="toolbar">
              <button class="ghost" id="validateBtn">Reâ€‘validate</button>
              <button class="ghost" id="exportBtn">Export JSON</button>
              <label class="ghost" style="padding:10px 14px; border-radius:10px; border:1px solid var(--border); cursor:pointer;">
                Import JSON
                <input id="importInput" type="file" accept="application/json" style="display:none;" />
              </label>
              <button class="secondary" id="resetBtn">Reset chain</button>
            </div>
          </div>
          <p class="muted" style="margin-top: 10px;">Tip: use <strong>Tamper</strong> on a block below to simulate an attack. Then click <strong>Repair from here</strong> to fix downstream hashes. Press <span class="kbd">?</span> to open About.</p>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top: 20px;">
      <h2>Blocks</h2>
      <div class="body" style="overflow:auto; max-height: 55vh;">
        <table id="chainTable">
          <thead>
            <tr>
              <th style="min-width:60px;">#</th>
              <th style="min-width:150px;">Timestamp</th>
              <th style="min-width:140px;">Name</th>
              <th>Pledge</th>
              <th style="min-width:220px;">Prev Hash</th>
              <th style="min-width:220px;">Hash</th>
              <th style="min-width:210px;">Actions</th>
            </tr>
          </thead>
          <tbody id="chainTbody"></tbody>
        </table>
      </div>
    </section>

    <p class="footer">Made for demo purposes â€” a <em>simulated</em> blockchain to show transparency and tamperâ€‘detection. No proofâ€‘ofâ€‘work, no consensus, no wallets.</p>
  </main>

  <!-- Floating About button for small screens -->
  <button id="aboutBtnFab" class="fab" aria-label="About">About</button>

  <!-- About Modal -->
  <div class="modal-backdrop" id="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="modal">
      <header>
        <div class="wrap" style="padding:12px 16px; display:flex; align-items:center; justify-content:space-between;">
          <strong id="aboutTitle">About EcoPledge Tracker</strong>
          <div class="toolbar"><button class="ghost" id="aboutClose" aria-label="Close About">Close</button></div>
        </div>
      </header>
      <div class="body">
        <div class="wrap" style="padding:0 16px 16px;">
          <p><strong>What it is:</strong> a singleâ€‘file, browserâ€‘only demo that simulates a blockchain ledger for sustainability pledges. It demonstrates transparency and tamper detection with <code class="small">SHAâ€‘256</code> hashes and linked blocks.</p>
          <p class="muted">Tip: Press <span class="kbd">?</span> to open this dialog anytime.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const toHex = (buf) => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    const fmtTime = (ms) => new Date(ms).toLocaleString();

    async function sha256Hex(input) {
      const enc = new TextEncoder().encode(input);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return toHex(digest);
    }

    async function hashBlockPayload(index, timestamp, data, previousHash, nonce=0) {
      const payload = JSON.stringify({ index, timestamp, data, previousHash, nonce });
      return sha256Hex(payload);
    }

    function showAbout(open){ $('#aboutModal').style.display = open ? 'flex' : 'none'; }

    // ---------- Chain State ----------
    const StoreKey = 'ecoChain_v1';
    const state = { chain: [] };

    function save() {
      localStorage.setItem(StoreKey, JSON.stringify(state.chain));
    }
    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(StoreKey);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch { return null; }
    }

    function last() { return state.chain[state.chain.length - 1]; }

    async function createGenesis() {
      const block = {
        index: 0,
        timestamp: Date.now(),
        data: { name: 'genesis', pledge: 'EcoPledge chain initialized', category: 'system' },
        previousHash: '0'.repeat(64),
        nonce: 0,
        hash: ''
      };
      block.hash = await hashBlockPayload(block.index, block.timestamp, block.data, block.previousHash, block.nonce);
      state.chain = [block];
      save();
    }

    async function addBlock(data) {
      const prev = last();
      const next = {
        index: prev.index + 1,
        timestamp: Date.now(),
        data,
        previousHash: prev.hash,
        nonce: 0,
        hash: ''
      };
      next.hash = await hashBlockPayload(next.index, next.timestamp, next.data, next.previousHash, next.nonce);
      state.chain.push(next);
      save();
      await render();
    }

    async function validateChain() {
      const errors = [];
      for (let i = 0; i < state.chain.length; i++) {
        const b = state.chain[i];
        const expected = await hashBlockPayload(b.index, b.timestamp, b.data, b.previousHash, b.nonce);
        if (b.hash !== expected) {
          errors.push({ index: i, type: 'hash-mismatch', msg: `Block #${i} hash mismatch` });
        }
        if (i > 0) {
          const prev = state.chain[i - 1];
          if (b.previousHash !== prev.hash) {
            errors.push({ index: i, type: 'prev-mismatch', msg: `Block #${i} previousHash mismatch` });
          }
        }
      }
      return { valid: errors.length === 0, errors };
    }

    async function repairFrom(index) {
      if (index < 0 || index >= state.chain.length) return;
      for (let i = index; i < state.chain.length; i++) {
        const prev = i === 0 ? null : state.chain[i - 1];
        if (prev) state.chain[i].previousHash = prev.hash;
        state.chain[i].hash = await hashBlockPayload(state.chain[i].index, state.chain[i].timestamp, state.chain[i].data, state.chain[i].previousHash, state.chain[i].nonce);
      }
      save();
      await render();
    }

    // ---------- Rendering ----------
    async function render() {
      const tbody = $('#chainTbody');
      tbody.innerHTML = '';
      const { valid, errors } = await validateChain();

      const dot = $('#statusDot');
      const txt = $('#statusText');
      if (valid) {
        dot.classList.remove('bad'); dot.classList.add('ok');
        txt.textContent = 'Valid chain';
      } else {
        dot.classList.remove('ok'); dot.classList.add('bad');
        txt.textContent = `Invalid chain â€” ${errors.length} issue${errors.length>1?'s':''}`;
      }

      const invalidIdx = new Set(errors.map(e => e.index));

      for (const block of state.chain) {
        const tr = document.createElement('tr');
        if (invalidIdx.has(block.index)) tr.classList.add('invalid');
        tr.innerHTML = `
          <td>${block.index}</td>
          <td>${fmtTime(block.timestamp)}</td>
          <td>${escapeHtml(block.data?.name ?? '')}</td>
          <td>${escapeHtml(block.data?.pledge ?? '')} <span class="muted">(${escapeHtml(block.data?.category ?? 'n/a')})</span></td>
          <td><code class="small">${block.previousHash}</code></td>
          <td><code class="small">${block.hash}</code></td>
          <td>
            ${block.index === 0 ? '<span class="muted">genesis</span>' : `
              <button class="ghost" data-action="tamper" data-index="${block.index}">Tamper</button>
              <button class="ghost" data-action="repair" data-index="${block.index}">Repair from here</button>
            `}
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    // ---------- Handlers ----------
    async function init() {
      const existing = loadFromStorage();
      if (existing && existing.length) {
        state.chain = existing;
      } else {
        await createGenesis();
      }
      await render();

      $('#addBtn').addEventListener('click', async () => {
        const name = $('#name').value.trim() || 'Anonymous';
        const pledge = $('#pledge').value.trim();
        const category = $('#category').value;
        if (!pledge) { alert('Please enter your pledge.'); return; }
        await addBlock({ name, pledge, category });
        $('#pledge').value = '';
      });

      $('#sampleBtn').addEventListener('click', async () => {
        const samples = [
          { name: 'Ava', pledge: 'Biking to school 3x/week', category: 'transport' },
          { name: 'Leo', pledge: 'Switching to LED bulbs in my room', category: 'energy' },
          { name: 'Maya', pledge: 'Using a reusable bottle daily', category: 'waste' },
        ];
        for (const s of samples) { await addBlock(s); }
      });

      $('#validateBtn').addEventListener('click', render);

      $('#exportBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(state.chain, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'eco-pledge-chain.json'; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      });

      $('#importInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('Invalid format');
          state.chain = data;
          save();
          await render();
        } catch (err) {
          alert('Import failed: ' + err.message);
        }
        e.target.value = '';
      });

      $('#resetBtn').addEventListener('click', async () => {
        if (!confirm('Reset the chain? This clears local data.')) return;
        localStorage.removeItem(StoreKey);
        await createGenesis();
        await render();
      });

      $('#chainTable').addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const idx = parseInt(btn.dataset.index, 10);
        if (btn.dataset.action === 'tamper') {
          const b = state.chain[idx];
          const current = b.data?.pledge ?? '';
          const next = prompt(`Edit pledge text for block #${idx} (this simulates tampering)`, current);
          if (next == null) return;
          b.data.pledge = next;
          save();
          await render();
        }
        if (btn.dataset.action === 'repair') {
          await repairFrom(idx);
        }
      });

      // About modal wiring (header button, FAB, ESC/?)
      const openAbout = () => showAbout(true);
      const closeAbout = () => showAbout(false);
      $('#aboutBtnHeader').addEventListener('click', openAbout);
      $('#aboutBtnFab').addEventListener('click', openAbout);
      $('#aboutClose').addEventListener('click', closeAbout);
      $('#aboutModal').addEventListener('click', (e)=>{ if(e.target && e.target.id==='aboutModal') closeAbout(); });
      document.addEventListener('keydown', (e)=>{
        if (e.key === '?') openAbout();
        if (e.key === 'Escape') closeAbout();
      });
    }

    init();
  </script>
</body>
</html>